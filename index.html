<!DOCTYPE html>
<html lang="en">
<head>
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Electrical Suite – by Yasser Zakaria</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚡</text></svg>">
  <style>
    .glass-effect { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 10px 30px rgba(0,0,0,0.25); backdrop-filter: blur(10px); }
    .calc-button { background: linear-gradient(135deg, #6b46c1, #22c55e); box-shadow: 0 10px 20px rgba(34,197,94,0.35); }
    .calc-button:hover { filter: brightness(1.05); }
    .input-field { color: #000; background-color: #f8fafc; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    .input-field:focus { outline: 2px solid #22c55e; background-color: #fff; }
    .tab-active { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(59,130,246,0.2)); border-color: rgba(255,255,255,0.35); }
    .link-chip { background: rgba(255,255,255,0.08); }
    /* Align inputs nicely inside grid */
    .grid.sm\:grid-cols-2 > div { display:flex; flex-direction:column; justify-content:flex-end; }
    .grid.sm\:grid-cols-2 > div label { margin-bottom:6px; }
  </style>
<script type="text/javascript">
	atOptions = {
		'key' : '52612cca3815c1ad36409099cc68adce',
		'format' : 'iframe',
		'height' : 250,
		'width' : 300,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/52612cca3815c1ad36409099cc68adce/invoke.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-slate-900 to-slate-950 text-white">
  <header class="max-w-6xl mx-auto px-4 pt-10 pb-6 text-center">
    <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full link-chip border border-white/20">
      <i class="fas fa-bolt text-yellow-400"></i>
      <span class="text-sm tracking-wide">Electrical Calculator Suite</span>
    </div>
    <h1 class="text-4xl md:text-5xl font-extrabold mt-4">Power • Cables • Protection</h1>
    <p class="text-sm text-white/90 mt-3">
      <i class="fas fa-code text-yellow-400"></i>
      Designed by <strong class="text-white">YASSER ZAKARIA</strong> |
      <a href="https://www.linkedin.com/in/eng-yasser-zakaria/" target="_blank" class="underline hover:text-yellow-300"><i class="fab fa-linkedin text-blue-400"></i> LinkedIn</a>
    </p>
  </header>

  <!-- Linktree-style hub -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="grid md:grid-cols-4 sm:grid-cols-2 grid-cols-1 gap-4 mb-8">
      <button class="glass-effect rounded-2xl p-5 text-left hover:scale-[1.01] transition tab-btn tab-active" data-tab="pf">
        <div class="text-2xl mb-2"><i class="fa-solid fa-plug text-green-400"></i></div>
        <div class="font-bold">Power Factor</div>
        <div class="text-sm text-white/70">Correction & ROI</div>
      </button>
      <button class="glass-effect rounded-2xl p-5 text-left hover:scale-[1.01] transition tab-btn" data-tab="vd">
        <div class="text-2xl mb-2"><i class="fa-solid fa-wave-square text-sky-400"></i></div>
        <div class="font-bold">Voltage Drop</div>
        <div class="text-sm text-white/70">ΔV% & sizing hint</div>
      </button>
      <button class="glass-effect rounded-2xl p-5 text-left hover:scale-[1.01] transition tab-btn" data-tab="cs">
        <div class="text-2xl mb-2"><i class="fa-solid fa-cable-car text-purple-400"></i></div>
        <div class="font-bold">Cable Sizing</div>
        <div class="text-sm text-white/70">Thermal + corrections</div>
      </button>
      <button class="glass-effect rounded-2xl p-5 text-left hover:scale-[1.01] transition tab-btn" data-tab="mccb">
        <div class="text-2xl mb-2"><i class="fa-solid fa-shield-halved text-amber-400"></i></div>
        <div class="font-bold">MCB/MCCB Selector</div>
        <div class="text-sm text-white/70">Trip curve & rating</div>
      </button>
    </div>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-16 space-y-10">

    <!-- TAB: Power Factor -->
    <section id="tab-pf" class="space-y-8">
      <div class="text-center">
        <h2 class="text-3xl font-bold"><i class="fas fa-bolt text-yellow-400"></i> Power Factor Correction</h2>
        <p class="text-gray-300">IEC 60831 / IEEE 1036 – quick calculator with ROI</p>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Inputs -->
        <div class="glass-effect rounded-2xl p-6 space-y-4">
          <h3 class="text-xl font-bold mb-2"><i class="fas fa-sliders text-green-400"></i> Inputs</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-white font-semibold mb-2">Active Power P (kW)</label>
              <input type="number" id="pf_P" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="500" min="1" step="0.1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Present PF</label>
              <input type="number" id="pf_pf1" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.80" min="0.1" max="1" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Target PF</label>
              <input type="number" id="pf_pf2" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.95" min="0.5" max="1" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Voltage (kV) <span class="text-white/60 text-xs">(for cost est.)</span></label>
              <input type="number" id="pf_voltage" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.4" min="0.22" max="33" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Demand Charge (USD/kVA·month)</label>
              <input type="number" id="pf_demand" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="3" min="0" step="0.1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Energy Cost (USD/kWh) <span class="text-white/60 text-xs">optional</span></label>
              <input type="number" id="pf_energy" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.03" min="0" step="0.001" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Operating Hours / year</label>
              <input type="number" id="pf_hours" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="8760" min="1" max="8760" step="1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Derating / Margin</label>
              <select id="pf_derate" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="1.00">1.00 – Normal</option>
                <option value="1.10" selected>1.10 – Hot</option>
                <option value="1.15">1.15 – Hot + Harmonics</option>
              </select>
            </div>
          </div>
          <button class="calc-button w-full py-4 px-6 rounded-xl text-white font-bold text-lg mt-2" onclick="calcPF()"><i class="fas fa-calculator mr-2"></i>Calculate</button>
          <button class="w-full py-3 px-6 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 mt-2" onclick="resetPF()"><i class="fas fa-redo mr-2"></i>Reset</button>
        </div>

        <!-- Unified Output -->
        <div class="glass-effect rounded-2xl p-6 xl:col-span-2" id="pf_panel">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-bar text-purple-400"></i> Output</h3>
          <div id="pf_out" class="space-y-2 text-white/90 text-sm mb-4">
            <div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>
          </div>
          <div id="pf_charts_wrap" class="grid md:grid-cols-2 gap-6 hidden">
            <div class="bg-white/10 rounded-lg p-4">
              <h4 class="font-semibold mb-2">PF & kVA</h4>
              <canvas id="pfChart1" height="180"></canvas>
            </div>
            <div class="bg-white/10 rounded-lg p-4">
              <h4 class="font-semibold mb-2">Investment vs Savings</h4>
              <canvas id="pfChart2" height="180"></canvas>
            </div>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700" onclick="pfReport()">
              <i class="fa-solid fa-file-pdf mr-2"></i>PDF Report
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Voltage Drop -->
    <section id="tab-vd" class="space-y-8 hidden">
      <div class="text-center">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-wave-square text-sky-400"></i> Voltage Drop</h2>
        <p class="text-gray-300">ΔV based on R & X – IEC simplified</p>
      </div>
      <div class="grid xl:grid-cols-3 gap-8">
        <div class="glass-effect rounded-2xl p-6 space-y-4">
          <h3 class="text-xl font-bold mb-2"><i class="fas fa-sliders text-green-400"></i> Inputs</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-white font-semibold mb-2">System</label>
              <select id="vd_phase" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="3" selected>3-Phase</option>
                <option value="1">1-Phase</option>
              </select>
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Voltage (V)</label>
              <input type="number" id="vd_V" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="400" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Load Power (kW) <span class="text-xs text-white/70">or set Current</span></label>
              <input type="number" id="vd_P" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="75" step="0.1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Current I (A) <span class="text-xs text-white/70">optional</span></label>
              <input type="number" id="vd_I" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" placeholder="auto from kW & PF" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Power Factor</label>
              <input type="number" id="vd_pf" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.85" min="0.1" max="1" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Length one-way (m)</label>
              <input type="number" id="vd_L" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="120" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Conductor Area (mm²)</label>
              <input type="number" id="vd_A" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="35" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Material</label>
              <select id="vd_mat" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="cu" selected>Copper</option>
                <option value="al">Aluminium</option>
              </select>
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Reactance X (Ω/km)</label>
              <input type="number" id="vd_X" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.08" step="0.01" />
            </div>
          </div>
          <button class="calc-button w-full py-4 px-6 rounded-xl text-white font-bold text-lg mt-2" onclick="calcVD()"><i class="fas fa-calculator mr-2"></i>Calculate</button>
          <button class="w-full py-3 px-6 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 mt-2" onclick="resetVD()"><i class="fas fa-redo mr-2"></i>Reset</button>
        </div>
        <div class="glass-effect rounded-2xl p-6 xl:col-span-2">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-bar text-purple-400"></i> Output</h3>
          <div id="vd_out" class="space-y-2 text-white/90 text-sm mb-4">
            <div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>
          </div>
          <div id="vd_chart_wrap" class="hidden">
            <canvas id="vdChart" height="160" class="mt-1"></canvas>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700" onclick="vdReport()"><i class='fa-solid fa-file-pdf mr-2'></i>PDF Report</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Cable Sizing -->
    <section id="tab-cs" class="space-y-8 hidden">
      <div class="text-center">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-cable-car text-purple-400"></i> Cable Sizing</h2>
        <p class="text-gray-300">Thermal ampacity with simple correction factors</p>
      </div>
      <div class="grid xl:grid-cols-3 gap-8">
        <div class="glass-effect rounded-2xl p-6 space-y-4">
          <h3 class="text-xl font-bold mb-2"><i class="fas fa-sliders text-green-400"></i> Inputs</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-white font-semibold mb-2">System</label>
              <select id="cs_phase" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="3" selected>3-Phase</option>
                <option value="1">1-Phase</option>
              </select>
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Voltage (V)</label>
              <input type="number" id="cs_V" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="400" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Load Power (kW)</label>
              <input type="number" id="cs_P" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="75" step="0.1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Power Factor</label>
              <input type="number" id="cs_pf" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.85" min="0.1" max="1" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Ambient Temp (°C)</label>
              <input type="number" id="cs_Ta" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="40" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Grouping (no. of cables)</label>
              <input type="number" id="cs_group" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="3" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Insulation</label>
              <select id="cs_ins" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="PVC" selected>PVC</option>
                <option value="XLPE">XLPE</option>
              </select>
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Material</label>
              <select id="cs_mat" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="cu" selected>Copper</option>
                <option value="al">Aluminium</option>
              </select>
            </div>
          </div>
          <button class="calc-button w-full py-4 px-6 rounded-xl text-white font-bold text-lg mt-2" onclick="calcCS()"><i class="fas fa-calculator mr-2"></i>Calculate</button>
          <button class="w-full py-3 px-6 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 mt-2" onclick="resetCS()"><i class="fas fa-redo mr-2"></i>Reset</button>
        </div>
        <div class="glass-effect rounded-2xl p-6 xl:col-span-2">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-bar text-purple-400"></i> Output</h3>
          <div id="cs_out" class="space-y-2 text-white/90 text-sm mb-4">
            <div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>
          </div>
          <div id="cs_chart_wrap" class="hidden">
            <canvas id="csChart" height="160" class="mt-1"></canvas>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700" onclick="csReport()"><i class='fa-solid fa-file-pdf mr-2'></i>PDF Report</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: MCCB/MCB Selector -->
    <section id="tab-mccb" class="space-y-8 hidden">
      <div class="text-center">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-shield-halved text-amber-400"></i> MCB / MCCB Selector</h2>
        <p class="text-gray-300">Quick pick: rating & curve (est.)</p>
      </div>
      <div class="grid xl:grid-cols-3 gap-8">
        <div class="glass-effect rounded-2xl p-6 space-y-4">
          <h3 class="text-xl font-bold mb-2"><i class="fas fa-sliders text-green-400"></i> Inputs</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-white font-semibold mb-2">Load Type</label>
              <select id="brk_load" class="input-field w-full p-3 rounded-lg bg-white/90 border-0">
                <option value="motor" selected>Motor</option>
                <option value="resistive">Resistive</option>
                <option value="mixed">Mixed</option>
              </select>
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Rated Power (kW)</label>
              <input type="number" id="brk_P" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="75" step="0.1" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Voltage (V)</label>
              <input type="number" id="brk_V" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="400" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Power Factor</label>
              <input type="number" id="brk_pf" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.85" min="0.1" max="1" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Efficiency η</label>
              <input type="number" id="brk_eta" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="0.92" step="0.01" />
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Start Multiple (×In) <span class="text-xs text-white/70">motors</span></label>
              <input type="number" id="brk_start" class="input-field w-full p-3 rounded-lg bg-white/90 border-0" value="6" step="0.5" />
            </div>
          </div>
          <button class="calc-button w-full py-4 px-6 rounded-xl text-white font-bold text-lg mt-2" onclick="calcBRK()"><i class="fas fa-calculator mr-2"></i>Calculate</button>
          <button class="w-full py-3 px-6 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 mt-2" onclick="resetBRK()"><i class="fas fa-redo mr-2"></i>Reset</button>
        </div>
        <div class="glass-effect rounded-2xl p-6 xl:col-span-2">
          <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-bar text-purple-400"></i> Output</h3>
          <div id="brk_out" class="space-y-2 text-white/90 text-sm mb-4">
            <div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>
          </div>
          <div id="brk_chart_wrap" class="hidden">
            <canvas id="brkChart" height="160" class="mt-1"></canvas>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700" onclick="brkReport()"><i class='fa-solid fa-file-pdf mr-2'></i>PDF Report</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-center text-white/70 text-sm">
    <p>Based on engineering approximations. Always verify with manufacturer / standards for final design.</p>
  </footer>

  <script>
    console.log('Electrical Suite (unified) loaded OK');

    // ---- Tab switching ----
    const tabs = { pf: document.getElementById('tab-pf'), vd: document.getElementById('tab-vd'), cs: document.getElementById('tab-cs'), mccb: document.getElementById('tab-mccb') };
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        const key = btn.dataset.tab;
        Object.entries(tabs).forEach(([k, el]) => el.classList.toggle('hidden', k !== key));
      });
    });

    // ========= Helper: Export chart with black text on white background =========
    function exportChartImage(chartInst) {
      if (!chartInst) return null;
      // Save previous colors
      const prev = {
        legendColor: chartInst.options?.plugins?.legend?.labels?.color,
        scales: {}
      };
      const scales = chartInst.options.scales || {};
      Object.keys(scales).forEach(k => {
        prev.scales[k] = {
          ticksColor: scales[k].ticks ? scales[k].ticks.color : undefined,
          gridColor: scales[k].grid ? scales[k].grid.color : undefined
        };
        if (!scales[k].ticks) scales[k].ticks = {};
        if (!scales[k].grid) scales[k].grid = {};
        scales[k].ticks.color = '#000';
        scales[k].grid.color = '#e5e7eb'; // light gray
      });
      if (!chartInst.options.plugins) chartInst.options.plugins = {};
      if (!chartInst.options.plugins.legend) chartInst.options.plugins.legend = { labels: {} };
      if (!chartInst.options.plugins.legend.labels) chartInst.options.plugins.legend.labels = {};
      chartInst.options.plugins.legend.labels.color = '#000';

      // Update to draw with black text
      chartInst.update('none');

      // Ensure white background under the chart
      const c = chartInst.canvas;
      const tmp = document.createElement('canvas');
      tmp.width = c.width;
      tmp.height = c.height;
      const tctx = tmp.getContext('2d');
      tctx.fillStyle = '#fff';
      tctx.fillRect(0,0,tmp.width,tmp.height);
      tctx.drawImage(c,0,0);

      const dataURL = tmp.toDataURL('image/png', 1.0);

      // Restore old colors
      if (chartInst.options.plugins.legend.labels) {
        chartInst.options.plugins.legend.labels.color = prev.legendColor;
      }
      Object.keys(prev.scales).forEach(k => {
        if (scales[k].ticks) scales[k].ticks.color = prev.scales[k].ticksColor;
        if (scales[k].grid) scales[k].grid.color = prev.scales[k].gridColor;
      });
      chartInst.update('none');

      return dataURL;
    }

    // ========= POWER FACTOR =========
    let pfChart1, pfChart2; let pfState = null;
    function tanphi(pf){ pf = Math.min(Math.max(pf,0.01), 0.9999); return Math.sqrt(1-pf*pf)/pf; }
    function pfCostPerKvar(kV){ if (kV <= 0.48) return 12; if (kV <= 11) return 20; return 35; }

    function calcPF(){
      const P = +document.getElementById('pf_P').value; // kW
      const pf1 = +document.getElementById('pf_pf1').value;
      const pf2 = +document.getElementById('pf_pf2').value;
      const kV = +document.getElementById('pf_voltage').value;
      const demand = +document.getElementById('pf_demand').value || 0;
      const energy = +document.getElementById('pf_energy').value || 0; // optional
      const hours = +document.getElementById('pf_hours').value || 0;
      const derate = +document.getElementById('pf_derate').value;

      const Qc = P * (tanphi(pf1) - tanphi(pf2)) * derate; // kVAr
      const kvarRounded = Math.max(0, Math.round(Qc));

      const S1 = P/pf1, S2 = P/pf2; // kVA
      const demandReduction = Math.max(0, S1 - S2); // kVA
      const monthlySavings = demandReduction * demand; // USD/month

      let energySavings = 0;
      if (energy > 0 && hours > 0){
        const I1 = S1; const I2 = S2;
        const lossFrac = (I1*I1 - I2*I2) / (I1*I1);
        energySavings = Math.max(0, P * Math.max(0, lossFrac) * 0.02 * hours * energy);
      }

      const capex = kvarRounded * pfCostPerKvar(kV);
      const annualSavings = monthlySavings*12 + energySavings;
      const paybackMonths = (annualSavings>0) ? (capex / (annualSavings/12)) : Infinity;
      const roiPct = (annualSavings>0) ? (annualSavings/capex*100) : 0;

      const out = document.getElementById('pf_out');
      out.innerHTML = `
        <div>Required Capacitors: <strong class="text-yellow-300">${kvarRounded.toLocaleString()} kVAr</strong> (incl. margin)</div>
        <div>kVA Reduction: <strong>${demandReduction.toFixed(2)} kVA</strong></div>
        <div>Monthly Savings: <strong>$${monthlySavings.toFixed(2)}</strong> | Energy Savings (est.): <strong>$${energySavings.toFixed(0)}</strong>/yr</div>
        <div>CAPEX (est.): <strong>$${capex.toLocaleString()}</strong></div>
        <div>Annual Savings: <strong>$${annualSavings.toFixed(0)}</strong> | Payback: <strong>${isFinite(paybackMonths)?paybackMonths.toFixed(1):'—'} months</strong> | ROI≈ <strong>${roiPct.toFixed(0)}%</strong></div>
      `;

      // show charts area
      document.getElementById('pf_charts_wrap').classList.remove('hidden');

      const ctx1 = document.getElementById('pfChart1');
      const ctx2 = document.getElementById('pfChart2');
      if (pfChart1 && typeof pfChart1.destroy === 'function') pfChart1.destroy();
      if (pfChart2 && typeof pfChart2.destroy === 'function') pfChart2.destroy();
      pfChart1 = new Chart(ctx1, { type:'bar', data:{ labels:['Present','Corrected'], datasets:[ {label:'Power Factor', data:[pf1,pf2]}, {label:'Apparent Power (kVA)', data:[S1,S2]}, ]}, options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} } });
      pfChart2 = new Chart(ctx2, { type:'doughnut', data:{ labels:['Investment','Annual Savings','Net (5y)'], datasets:[{ data:[capex, annualSavings, annualSavings*5-capex] }] }, options:{ plugins:{legend:{labels:{color:'#fff'}}} } });

      pfState = {P,pf1,pf2,kV,demand,energy,hours,derate,kvarRounded,capex,annualSavings,paybackMonths,roiPct,S1,S2};
    }

    function resetPF(){ 
      document.querySelectorAll('#tab-pf input').forEach(i=>{ 
        if(i.type==='number') i.value=i.id==='pf_pf1'?0.80:i.id==='pf_pf2'?0.95:i.id==='pf_voltage'?0.4:i.id==='pf_hours'?8760:i.id==='pf_energy'?0.03:i.value;
      }); 
      // destroy charts + hide section + reset text
      if(pfChart1 && typeof pfChart1.destroy === 'function') pfChart1.destroy(); 
      if(pfChart2 && typeof pfChart2.destroy === 'function') pfChart2.destroy(); 
      document.getElementById('pf_out').innerHTML = `<div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>`;
      document.getElementById('pf_charts_wrap').classList.add('hidden');
    }

    function pfReport(){ 
      if(!pfState){ alert('Calculate first'); return; } 
      const { jsPDF } = window.jspdf; 
      const doc = new jsPDF('p','pt','a4'); 
      const pageW = doc.internal.pageSize.getWidth(); 
      let y=60; 
      doc.setFontSize(18); doc.text('Power Factor Correction Report', 40, y); y+=22; 
      doc.setFontSize(11); 
      const t = pfState; 
      const lines = [ 
        `Active Power P: ${t.P} kW`, 
        `PF (present → target): ${t.pf1} → ${t.pf2}`, 
        `Voltage (kV): ${t.kV}`, 
        `Demand Charge: $${t.demand}/kVA·mo`, 
        `Energy Cost: $${t.energy}/kWh · Hours/yr: ${t.hours}`, 
        `Derating/Margin: ${t.derate}`, 
        `Required Capacitors: ${t.kvarRounded} kVAr`, 
        `kVA Reduction: ${(t.S1 - t.S2).toFixed(2)} kVA`, 
        `CAPEX (est.): $${t.capex.toLocaleString()}`, 
        `Annual Savings: $${t.annualSavings.toFixed(0)} | Payback: ${isFinite(t.paybackMonths)?t.paybackMonths.toFixed(1):'—'} mo | ROI≈ ${t.roiPct.toFixed(0)}%` 
      ]; 
      lines.forEach(s => { doc.text(s, 40, y); y += 16; }); 
      try{ 
        if (pfChart1){ const img1 = exportChartImage(pfChart1); if(img1){ doc.addImage(img1, 'PNG', 40, y+10, pageW-80, 180); y += 200; } } 
        if (pfChart2){ const img2 = exportChartImage(pfChart2); if(img2){ doc.addImage(img2, 'PNG', 80, y+10, pageW-160, 200); y += 220; } } 
      }catch(e){} 
      doc.setFontSize(9); doc.text('Generated with Electrical Suite – Yasser Zakaria', 40, doc.internal.pageSize.getHeight()-30); 
      doc.save('pf_report.pdf'); 
    }

    // ========= VOLTAGE DROP =========
    let vdChart; let lastVD = null;
    function resistivity(material){ return material==='al' ? 0.028264 : 0.017241; }

    function calcVD(){
      const ph = +document.getElementById('vd_phase').value;
      const V = +document.getElementById('vd_V').value;
      const P = +document.getElementById('vd_P').value;
      let I = +document.getElementById('vd_I').value || 0;
      const pf = +document.getElementById('vd_pf').value;
      const L = +document.getElementById('vd_L').value;
      const A = +document.getElementById('vd_A').value;
      const mat = document.getElementById('vd_mat').value;
      const X_km = +document.getElementById('vd_X').value;

      if(!I || I<=0){ I = ph===3 ? (P*1000)/(Math.sqrt(3)*V*pf) : (P*1000)/(V*pf); }
      const R = resistivity(mat) * (L*2) / A; // loop
      const X = (X_km/1000) * (L*2);
      const cos = pf, sin = Math.sqrt(Math.max(0,1-pf*pf));
      const k = ph===3 ? Math.sqrt(3) : 2;
      const dV = k * I * (R*cos + X*sin);
      const dVpct = (dV / V) * 100;

      const out = document.getElementById('vd_out');
      out.innerHTML = `
        <div>Current used: <strong>${I.toFixed(1)} A</strong></div>
        <div>R (loop): <strong>${R.toFixed(4)} Ω</strong> | X (loop): <strong>${X.toFixed(4)} Ω</strong></div>
        <div>Voltage Drop: <strong class="text-yellow-300">${dV.toFixed(2)} V</strong> (<strong>${dVpct.toFixed(2)}%</strong>)</div>
        <div>Hint: if ΔV% > 3% (feeders) or 5% (final), consider a higher CSA.</div>
      `;

      const csaList = [10,16,25,35,50,70,95,120,150,185,240,300,400];
      let better = null; for(const a of csaList){ if(a>A){ const R2 = resistivity(mat)* (L*2) / a; const dV2 = k * I * (R2*cos + X*sin); const pct = dV2/V*100; if(pct < 3.0){ better = a; break; } } }
      if(better){ out.innerHTML += `<div class='mt-1'>Suggested CSA to keep ΔV<3%: <strong class='text-green-300'>${better} mm²</strong></div>`; }

      const ctx = document.getElementById('vdChart');
      if (vdChart && typeof vdChart.destroy === 'function') vdChart.destroy();
      const xs = csaList.map(a=>{ const R3 = resistivity(mat)* (L*2) / a; const d = k*I*(R3*cos + X*sin)/V*100; return d;});
      vdChart = new Chart(ctx, { type:'line', data:{ labels:csaList, datasets:[{ label:'ΔV% vs CSA', data:xs }] }, options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} } });
      lastVD = {ph,V,P,I,pf,L,A,mat,X_km,dV,dVpct};

      // show chart area
      document.getElementById('vd_chart_wrap').classList.remove('hidden');
    }
    function resetVD(){ 
      document.querySelectorAll('#tab-vd input').forEach(i=>i.value=''); 
      document.getElementById('vd_V').value=400; document.getElementById('vd_P').value=75; document.getElementById('vd_pf').value=0.85; document.getElementById('vd_L').value=120; document.getElementById('vd_A').value=35; document.getElementById('vd_X').value=0.08; 
      document.getElementById('vd_out').innerHTML = `<div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>`; 
      if(vdChart && typeof vdChart.destroy === 'function') vdChart.destroy();
      document.getElementById('vd_chart_wrap').classList.add('hidden');
    }

    function vdReport(){ 
      if(!lastVD){ alert('Calculate first'); return; } 
      const { jsPDF } = window.jspdf; 
      const doc = new jsPDF('p','pt','a4'); 
      const pageW = doc.internal.pageSize.getWidth(); 
      let y=60; 
      doc.setFontSize(18); doc.text('Voltage Drop Report', 40, y); y+=22; 
      doc.setFontSize(11); 
      const t = lastVD; 
      const lines=[`System: ${t.ph===3?'3-Phase':'1-Phase'}`,`Voltage: ${t.V} V · PF: ${t.pf}`,`Power: ${t.P} kW · Current used: ${t.I.toFixed(1)} A`, `Length (one-way): ${t.L} m`, `CSA: ${t.A} mm² ${t.mat.toUpperCase()}`, `Reactance: ${t.X_km} Ω/km`, `ΔV: ${t.dV.toFixed(2)} V (${t.dVpct.toFixed(2)}%)`]; 
      lines.forEach(s=>{ doc.text(s,40,y); y+=16; }); 
      try{ 
        if (vdChart){ const img = exportChartImage(vdChart); if(img){ doc.addImage(img,'PNG',40,y+10,pageW-80,200); y+=220; } } 
      }catch(e){} 
      doc.setFontSize(9); doc.text('Generated with Electrical Suite – Yasser Zakaria', 40, doc.internal.pageSize.getHeight()-30); 
      doc.save('voltage_drop_report.pdf'); 
    }

    // ========= CABLE SIZING =========
    function currentFrom(P, V, pf, ph){ return ph===3 ? (P*1000)/(Math.sqrt(3)*V*pf) : (P*1000)/(V*pf); }
    const AMPACITY = { cu: { PVC: { 1: [10,16,25,35,50,70,95,120,150,185,240], 3: [10,16,25,35,50,70,95,120,150,185,240] }, XLPE:{ 1: [10,16,25,35,50,70,95,120,150,185,240], 3: [10,16,25,35,50,70,95,120,150,185,240] } }, al: { PVC: { 1: [16,25,35,50,70,95,120,150,185,240,300], 3: [16,25,35,50,70,95,120,150,185,240,300] }, XLPE:{ 1: [16,25,35,50,70,95,120,150,185,240,300], 3: [16,25,35,50,70,95,120,150,185,240,300] } } };
    const NOMINAL_A = { cu:{ 10:50,16:70,25:95,35:120,50:150,70:195,95:235,120:265,150:300,185:340,240:395,300:455,400:520 }, al:{ 16:50,25:65,35:80,50:100,70:125,95:155,120:180,150:205,185:235,240:275,300:315,400:360 } };
    function tempFactorPVC(Ta){ if(Ta<=30) return 1; if(Ta<=35) return 0.94; if(Ta<=40) return 0.87; if(Ta<=45) return 0.79; if(Ta<=50) return 0.71; return 0.61; }
    function tempFactorXLPE(Ta){ if(Ta<=30) return 1; if(Ta<=35) return 0.97; if(Ta<=40) return 0.94; if(Ta<=45) return 0.90; if(Ta<=50) return 0.87; return 0.82; }
    function groupingFactor(n){ if(n<=1) return 1; if(n==2) return 0.8; if(n==3) return 0.7; if(n==4) return 0.65; if(n==5) return 0.6; return 0.57; }

    function calcCS(){
      const ph = +document.getElementById('cs_phase').value;
      const V = +document.getElementById('cs_V').value;
      const P = +document.getElementById('cs_P').value;
      const pf = +document.getElementById('cs_pf').value;
      const Ta = +document.getElementById('cs_Ta').value;
      const g = +document.getElementById('cs_group').value;
      const ins = document.getElementById('cs_ins').value;
      const mat = document.getElementById('cs_mat').value;

      const I = currentFrom(P,V,pf,ph);
      const tF = ins==='PVC'? tempFactorPVC(Ta) : tempFactorXLPE(Ta);
      const gF = groupingFactor(g);
      const req = I/(tF*gF);

      const set = AMPACITY[mat][ins][ph];
      let chosen = set[0];
      for(const a of set){ const In = (NOMINAL_A[mat][a]||0); if(In >= req){ chosen = a; break; } }

      const out = document.getElementById('cs_out');
      out.innerHTML = `
        <div>Calculated Current: <strong>${I.toFixed(1)} A</strong></div>
        <div>Derating: temp <strong>${tF}</strong> × grouping <strong>${gF}</strong> → required ampacity <strong>${req.toFixed(1)} A</strong></div>
        <div>Recommended CSA: <strong class="text-green-300">${chosen} mm² ${mat.toUpperCase()} ${ins}</strong> (nominal ${NOMINAL_A[mat][chosen]||'?'} A)</div>
        <div class="text-white/70 text-xs">Reference values are indicative. Check manufacturer tables for exact installation method.</div>
      `;
      const ctx = document.getElementById('csChart');
      if (window.csChartInst && typeof window.csChartInst.destroy === 'function') window.csChartInst.destroy();
      const reqA = req; const chosenA = NOMINAL_A[mat][chosen]||req;
      window.csChartInst = new Chart(ctx, { type:'bar', data:{ labels:['Required','Selected'], datasets:[{ label:'Ampacity (A)', data:[reqA, chosenA] }] }, options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} } });
      window.lastCS = {ph,V,P,pf,Ta,g,ins,mat,I,tF,gF,req,chosen,chosenA};

      document.getElementById('cs_chart_wrap').classList.remove('hidden');
    }
    function resetCS(){ 
      document.querySelectorAll('#tab-cs input').forEach(i=>i.value=''); 
      document.getElementById('cs_V').value=400; document.getElementById('cs_P').value=75; document.getElementById('cs_pf').value=0.85; document.getElementById('cs_Ta').value=40; document.getElementById('cs_group').value=3; 
      document.getElementById('cs_out').innerHTML = `<div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>`; 
      if (window.csChartInst && typeof window.csChartInst.destroy === 'function') window.csChartInst.destroy(); 
      document.getElementById('cs_chart_wrap').classList.add('hidden');
    }

    function csReport(){ 
      if(!window.lastCS){ alert('Calculate first'); return; } 
      const { jsPDF } = window.jspdf; 
      const doc = new jsPDF('p','pt','a4'); const pageW = doc.internal.pageSize.getWidth(); let y=60; 
      doc.setFontSize(18); doc.text('Cable Sizing Report', 40, y); y+=22; 
      doc.setFontSize(11); 
      const t = window.lastCS; 
      const lines=[`System: ${t.ph===3?'3-Phase':'1-Phase'} · Voltage: ${t.V} V`,`Power: ${t.P} kW · PF: ${t.pf}`,`Ambient: ${t.Ta} °C · Grouping: ${t.g}`,`Insulation: ${t.ins} · Material: ${t.mat.toUpperCase()}`,`Calculated Current: ${t.I.toFixed(1)} A`,`Derating: temp ${t.tF} × grouping ${t.gF}`,`Required ampacity: ${t.req.toFixed(1)} A`,`Selected: ${t.chosen} mm² (${t.chosenA} A nominal)`]; 
      lines.forEach(s=>{ doc.text(s,40,y); y+=16; }); 
      try{ 
        if (window.csChartInst){ const img = exportChartImage(window.csChartInst); if(img){ doc.addImage(img,'PNG',40,y+10,pageW-80,200); y+=220; } } 
      }catch(e){} 
      doc.setFontSize(9); doc.text('Generated with Electrical Suite – Yasser Zakaria', 40, doc.internal.pageSize.getHeight()-30); 
      doc.save('cable_sizing_report.pdf'); 
    }

    // ========= BREAKER SELECTOR =========
    function roundTo(list, val){ for(const x of list){ if(x>=val) return x; } return list[list.length-1]; }
    function calcBRK(){
      const type = document.getElementById('brk_load').value;
      const P = +document.getElementById('brk_P').value;
      const V = +document.getElementById('brk_V').value;
      const pf = +document.getElementById('brk_pf').value;
      const eta = +document.getElementById('brk_eta').value;
      const k = +document.getElementById('brk_start').value;

      const I = (P*1000)/(Math.sqrt(3)*V*pf*eta);
      const mult = type==='motor'? 1.25 : (type==='mixed'? 1.15 : 1.00);
      const In_req = I*mult;
      const stds = [16,20,25,32,40,50,63,80,100,125,160,200,250,315,400,500,630,800];
      const In = roundTo(stds, In_req);
      let curve = 'C'; if(type==='motor') curve = k>=6? 'D' : 'C'; if(type==='resistive') curve = 'B';

      const out = document.getElementById('brk_out');
      out.innerHTML = `
        <div>FLA ≈ <strong>${I.toFixed(1)} A</strong></div>
        <div>Recommended breaker rating In: <strong class="text-green-300">${In} A</strong> (req. ${In_req.toFixed(1)} A)</div>
        <div>Suggested curve: <strong>${curve}</strong> ${type==='motor'?'(motor start '+k+'×In)':''}</div>
        <div class="text-white/70 text-xs">Always verify Ik (short-circuit) and coordination with upstream/downstream devices.</div>
      `;
      const ctx = document.getElementById('brkChart');
      if (window.brkChartInst && typeof window.brkChartInst.destroy === 'function') window.brkChartInst.destroy();
      window.brkChartInst = new Chart(ctx, { type:'bar', data:{ labels:['FLA','In required','In selected'], datasets:[{ label:'Amps', data:[I, In_req, In] }] }, options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} } });
      window.lastBRK = {type,P,V,pf,eta,k,I,In_req,In,curve};

      document.getElementById('brk_chart_wrap').classList.remove('hidden');
    }
    function resetBRK(){ 
      document.querySelectorAll('#tab-mccb input').forEach(i=>i.value=''); 
      document.getElementById('brk_P').value=75; document.getElementById('brk_V').value=400; document.getElementById('brk_pf').value=0.85; document.getElementById('brk_eta').value=0.92; document.getElementById('brk_start').value=6; 
      document.getElementById('brk_out').innerHTML = `<div class="text-white/60 italic">No results yet — enter inputs then click <strong>Calculate</strong>.</div>`; 
      if (window.brkChartInst && typeof window.brkChartInst.destroy === 'function') window.brkChartInst.destroy(); 
      document.getElementById('brk_chart_wrap').classList.add('hidden');
    }

    function brkReport(){ 
      if(!window.lastBRK){ alert('Calculate first'); return; } 
      const { jsPDF } = window.jspdf; 
      const doc = new jsPDF('p','pt','a4'); const pageW = doc.internal.pageSize.getWidth(); let y=60; 
      doc.setFontSize(18); doc.text('Breaker Selection Report', 40, y); y+=22; 
      doc.setFontSize(11); 
      const t = window.lastBRK; 
      const lines=[`Load type: ${t.type}`,`Power: ${t.P} kW · Voltage: ${t.V} V · PF: ${t.pf} · η: ${t.eta}`,`Start multiple: ${t.k}×In`,`FLA: ${t.I.toFixed(1)} A`,`Required In: ${t.In_req.toFixed(1)} A`,`Selected In: ${t.In} A · Curve: ${t.curve}`]; 
      lines.forEach(s=>{ doc.text(s,40,y); y+=16; }); 
      try{ 
        if (window.brkChartInst){ const img = exportChartImage(window.brkChartInst); if(img){ doc.addImage(img,'PNG',40,y+10,pageW-80,200); y+=220; } } 
      }catch(e){} 
      doc.setFontSize(9); doc.text('Generated with Electrical Suite – Yasser Zakaria', 40, doc.internal.pageSize.getHeight()-30); 
      doc.save('breaker_report.pdf'); 
    }
  </script>
</body>
</html>
